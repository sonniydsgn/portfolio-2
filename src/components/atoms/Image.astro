---
import Link from '@/components/atoms/ButtonLink.astro'
import type { ImageMetadata } from 'astro'
import { Picture } from 'astro:assets'

interface Props {
	src: ImageMetadata
	alt: string
	title?: string
}

const { src, alt, title, ...props } = Astro.props

// получаю ссылку из подписи к изображению
const parseLink = (text: string) => {
	const match = text.match(/\[(.*?)\]\((.*?)\)/)

	if (match) {
		const before = text.slice(0, match.index)
		const label = match[1]
		const href = match[2]
		const after = text.slice(match.index + match[0].length)

		return { before, label, href, after }
	}
}

const renderedTitle = title && parseLink(title)
---

{
	title ? (
		<figure>
			<Picture {src} {alt} formats={['webp', 'avif']} {...props} />
			<figcaption>
				{renderedTitle ? (
					<Fragment>
						{renderedTitle.before} <Link href={renderedTitle.href}>{renderedTitle.label}</Link> {renderedTitle.after}
					</Fragment>
				) : (
					title
				)}
			</figcaption>
		</figure>
	) : (
		<Picture {src} {alt} formats={['webp', 'avif']} {...props} />
	)
}

<style>
	picture img {
		display: flex;
		border-radius: var(--br-md);

		@media (width <= 880) {
			border-radius: var(--br-primary);
		}
	}
</style>
