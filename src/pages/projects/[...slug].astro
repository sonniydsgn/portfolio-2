---
import Link from '@/components/atoms/ButtonLink.astro'
import H3 from '@/components/atoms/H3.astro'
import Image from '@/components/atoms/Image.astro'
import InfoCard from '@/components/atoms/InfoCard.astro'
import ContentList from '@/components/molecules/ContentList.astro'
import Meta from '@/components/molecules/Meta.astro'
import ContentPlaceholder from '@/components/organisms/ContentPlaceholder.astro'
import Hero from '@/components/organisms/Hero.astro'
import NextCard from '@/components/organisms/NextCard.astro'
import ProjectLayout from '@/layouts/ProjectLayout.astro'

import getProjects from '@/scripts/getters/get-projects'
import type { ImageMetadata } from 'astro'
import { Picture } from 'astro:assets'

export async function getStaticPaths() {
	const projects = await getProjects()
	return projects.map(project => ({ params: { slug: project.slug }, props: { project } }))
}

const { project } = Astro.props
const { Content } = await project.render()

const { name: title, desc, place_work, color, cover, result, draft } = project.data

// todo: add toc
// select next page
const projects = await getProjects()
const nextProject = projects.find(({ slug }) => slug !== project.slug)

console.log(nextProject)
---

<ProjectLayout {title} {desc}>
	<article class="article" style={'--cover-color: ' + '#' + color}>
		<Hero class="article__hero" {title} {desc} tag="header" centered>
			<Meta
				class="article__meta"
				client={{
					logo: place_work.logo as ImageMetadata,
					name: project.data.place_work.name,
					href: project.data.place_work.link,
				}}
				year={project.data.year}
			/>
			<div class="article__cover">
				{
					cover.mp4 ? (
						<video
							class="article__image"
							poster={cover.img.src}
							autoplay
							preload="auto"
							loop
							muted
							playsinline
							width={1180}
							height={780}
						>
							<source src={cover.mp4} type="video/mp4" />
							<source src={cover.webm} type="video/webm" />
						</video>
					) : (
						<Picture
							class="article__image"
							src={cover.img as ImageMetadata}
							alt={cover?.alt}
							formats={['avif', 'webp']}
							width={1180}
							height={780}
						/>
					)
				}
			</div>
		</Hero>
		<div class="container container--main">
			<div class="article__layout">
				<ContentList tag="div" class="article__inner">
					<ContentList tag="div" class="article__content">
						<Content components={{ img: Image, h3: H3, a: Link }} />

						{
							draft && (
								<ContentPlaceholder>
									{result && <InfoCard name="Посмотреть сайт" href={result} />}
									<InfoCard name="Обсудить проект" href="https://t.me/sonniyboii" icon="message-text-icon" />
								</ContentPlaceholder>
							)
						}
					</ContentList>
					<NextCard
						title={nextProject.data.name}
						cover={nextProject.data.cover.img as ImageMetadata}
						color={nextProject.data.color}
						href={'/' + nextProject.collection + '/' + nextProject.slug}
					/>
				</ContentList>
				<!-- <Toc content={toc}/> -->
			</div>
		</div>
	</article>
</ProjectLayout>

<style>
	.article {
	}

	.article__hero {
		margin-inline: 24px;
	}

	.article__meta {
		margin-block-start: 32px;
	}

	.article__cover {
		margin-block-start: 48px;
		border-radius: var(--br-xl);
		background-color: var(--cover-color);
		width: 100%;
	}

	.article__image {
		display: flex;
		transform: scale(0.9);
		background-color: var(--bg-secondary);
		width: 100%;
	}

	.article__layout {
		grid-column: 2 / 3;
	}

	.article__content {
	}
</style>
