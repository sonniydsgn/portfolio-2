---
import Link from '@/components/atoms/ButtonLink.astro'
import H3 from '@/components/atoms/H3.astro'
import Image from '@/components/atoms/Image.astro'
import InfoCard from '@/components/atoms/InfoCard.astro'
import ContentList from '@/components/molecules/ContentList.astro'
import InfoList from '@/components/molecules/InfoList.astro'
import Meta from '@/components/molecules/Meta.astro'
import ContentPlaceholder from '@/components/organisms/ContentPlaceholder.astro'
import ContentSection from '@/components/organisms/ContentSection.astro'
import Hero from '@/components/organisms/Hero.astro'
import NextCard from '@/components/organisms/NextCard.astro'
import Toc from '@/components/organisms/Toc.astro'
import ProjectLayout from '@/layouts/ProjectLayout.astro'
import getProjects from '@/scripts/getters/get-projects'
import type { TocItem } from '@/types'
import type { ImageMetadata } from 'astro'
import { Picture } from 'astro:assets'
import { slugify, transliterate } from 'transliteration'

export async function getStaticPaths() {
	const projects = await getProjects()
	return projects.map(project => ({ params: { slug: project.slug }, props: { project } }))
}

const { project } = Astro.props
const { Content } = await project.render()

const { name: title, desc, place_work, color, cover, result, draft } = project.data

// select next page
const projects = await getProjects()
const currentIndex = projects.findIndex(p => p.slug === project.slug)
const nextProject = projects[currentIndex + 1] || projects[0]

// toc
const headings: TocItem[] = project.body
	.split('\n')
	.filter(line => line.includes(':::Section['))
	.map(line => line.match(/:::Section\[(.*?)\]/)![1])
	.map(title => ({ title, slug: '#' + slugify(transliterate(title)) }))

const needToc = headings.length >= 3 || (headings.length >= 2 && result && draft)

// cover
const coverWidth = 1440
const coverHeight = 952

// components
const Section = ContentSection
const List = InfoList
const Card = InfoCard
---

<ProjectLayout title={title + ' — Алексей Калинин'} {desc}>
	<article class="article" style={'--cover-color: ' + '#' + color}>
		<Hero class="article__hero" {title} {desc} tag="header" centered>
			<Meta
				class="article__meta"
				client={{
					logo: place_work.logo as ImageMetadata,
					name: project.data.place_work.name,
					href: project.data.place_work.link,
				}}
				year={project.data.year}
				slot="header"
			/>

			<div class="article__cover-container">
				{
					cover?.mp4?.length > 0 ? (
						<video
							class="article__cover"
							autoplay
							preload="auto"
							loop
							muted
							playsinline
							tabindex="-1"
							width={coverWidth}
							height={coverHeight}
							style={'aspect-ratio: ' + coverWidth + '/' + coverHeight}
						>
							<source src={cover.mp4} type="video/mp4" />
							<source src={cover.webm} type="video/webm" />
						</video>
					) : (
						<Picture
							class="article__cover"
							src={cover.img as ImageMetadata}
							alt={cover?.alt}
							loading="eager"
							fetchpriority="high"
							formats={['avif', 'webp']}
							width={coverWidth}
							height={coverHeight}
						/>
					)
				}
			</div>
		</Hero>

		<ContentList tag="div" class="article__list">
			<div class="container">
				<div class="article__inner grid grid--page">
					{
						needToc && (
							<Toc class="article__toc article__toc--desktop" list={headings} hasResult={draft && result != null} />
						)
					}

					<ContentList tag="div" class="article__content">
						{
							needToc && (
								<ContentSection
									class="article__toc article__toc--mobile"
									title="Содержание"
									icon="§"
									size="sm"
									type="accordion"
								>
									<Toc list={headings} hasResult={draft && result != null} mobile />
								</ContentSection>
							)
						}

						<Content components={{ img: Image, h3: H3, a: Link, Section, Card, List }} />

						{
							draft && (
								<ContentPlaceholder id="result" data-toc-section>
									{result && <InfoCard name="Посмотреть сайт" href={result} />}
									<InfoCard name="Обсудить проект" href="https://t.me/sonniyboii" icon="message-text-icon" />
								</ContentPlaceholder>
							)
						}
					</ContentList>
				</div>
			</div>
			<div class="article__other">
				<div class="container">
					<div class="article__other-inner grid grid--page">
						<NextCard
							class="article__next-page"
							title={nextProject.data.name}
							cover={nextProject.data.cover}
							color={nextProject.data.color}
							href={'/' + nextProject.collection + '/' + nextProject.slug}
						/>
					</div>
				</div>
			</div>
		</ContentList>
	</article>
</ProjectLayout>

<style>
	.article {
	}

	.article__hero {
		margin-inline: 24px;

		@media (width <= 1200) {
			margin-inline: 16px;
		}

		@media (width <= 880) {
			margin-inline: 8px;
		}
	}

	.article__meta {
		margin-block-start: 32px;

		@media (width <= 880) {
			margin-block-start: 16px;
		}
	}

	.article__cover-container {
		margin-block-start: 48px;
		border-radius: var(--br-xl);
		background-color: var(--cover-color);
		width: 100%;

		@media (width <= 1200) {
			margin-block-start: 40px;
		}

		@media (width <= 880) {
			margin-block-start: 32px;
			border-radius: var(--br-md);
		}
	}

	.article__cover {
		display: flex;
		transform: scale(0.9);
		background-color: var(--bg-placeholder);
		width: 100%;
	}

	.article__content,
	.article__next-page {
		grid-column: 2 / span 1;

		@media (width <= 1200) {
			grid-column: unset;
		}
	}

	.article__toc {
		margin-inline-start: 64px;

		&.article__toc--desktop {
			order: 1;
		}

		&.article__toc--mobile {
			display: none;
		}

		@media (width <= 1200) {
			grid-column: unset;
			margin-inline-start: unset;

			&.article__toc--desktop {
				display: none;
			}

			&.article__toc--mobile {
				display: flex;
			}
		}
	}

	.article__content {
	}
</style>
