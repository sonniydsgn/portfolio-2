---
import Link from '@/components/atoms/ButtonLink.astro'
import H3 from '@/components/atoms/H3.astro'
import Image from '@/components/atoms/Image.astro'
import InfoCard from '@/components/atoms/InfoCard.astro'
import ContentList from '@/components/molecules/ContentList.astro'
import Meta from '@/components/molecules/Meta.astro'
import ContentPlaceholder from '@/components/organisms/ContentPlaceholder.astro'
import Hero from '@/components/organisms/Hero.astro'
import NextCard from '@/components/organisms/NextCard.astro'
import Toc from '@/components/organisms/Toc.astro'
import ProjectLayout from '@/layouts/ProjectLayout.astro'
import slugify from '@/scripts/libs/slugify'
import type { TocItem } from '@/types'

import getProjects from '@/scripts/getters/get-projects'
import type { ImageMetadata } from 'astro'
import { Picture } from 'astro:assets'

export async function getStaticPaths() {
	const projects = await getProjects()
	return projects.map(project => ({ params: { slug: project.slug }, props: { project } }))
}

const { project } = Astro.props
const { Content } = await project.render()

const { name: title, desc, place_work, color, cover, result, draft } = project.data

// select next page
const projects = await getProjects()
const nextProject = projects.find(({ slug }) => slug !== project.slug)

// toc
const headings: TocItem[] = project.body
	.split('\n')
	.filter(line => line.includes('title'))
	.map(line => line.match(/title="([^"]+)"/)[1])
	.map(title => ({ title, slug: '#' + slugify(title) }))

const needToc = headings.length >= 3 || (headings.length >= 2 && result && draft)
---

<ProjectLayout title={title + ' — Алексей Калинин'} {desc}>
	<article class="article" style={'--cover-color: ' + '#' + color}>
		<Hero class="article__hero" {title} {desc} tag="header" centered>
			<Meta
				class="article__meta"
				client={{
					logo: place_work.logo as ImageMetadata,
					name: project.data.place_work.name,
					href: project.data.place_work.link,
				}}
				year={project.data.year}
			/>
			<div class="article__cover-container" transition:name={project.slug + '-cover'}>
				{
					cover.mp4 ? (
						<video
							class="article__cover"
							poster={cover.img.src}
							autoplay
							preload="auto"
							loop
							muted
							playsinline
							width={1180}
							height={780}
						>
							<source src={cover.mp4} type="video/mp4" />
							<source src={cover.webm} type="video/webm" />
						</video>
					) : (
						<Picture
							class="article__cover"
							src={cover.img as ImageMetadata}
							alt={cover?.alt}
							formats={['avif', 'webp']}
							width={1180}
							height={780}
						/>
					)
				}
			</div>
		</Hero>
		<ContentList tag="div" class="article__inner">
			<div class="container container--main">
				<ContentList tag="div" class="article__content">
					<Content components={{ img: Image, h3: H3, a: Link }} />
					{
						draft && (
							<ContentPlaceholder id="result" data-toc>
								{result && <InfoCard name="Посмотреть сайт" href={result} />}
								<InfoCard name="Обсудить проект" href="https://t.me/sonniyboii" icon="message-text-icon" />
							</ContentPlaceholder>
						)
					}
				</ContentList>

				{needToc && <Toc class="article__toc" list={headings} hasResult={draft && result != null} />}
			</div>
			<div class="container container--main">
				<NextCard
					class="article__next-page"
					title={nextProject.data.name}
					cover={nextProject.data.cover.img as ImageMetadata}
					color={nextProject.data.color}
					href={'/' + nextProject.collection + '/' + nextProject.slug}
				/>
			</div>
		</ContentList>
	</article>
</ProjectLayout>

<style>
	.article {
	}

	.article__hero {
		margin-inline: 24px;
	}

	.article__meta {
		margin-block-start: 32px;
	}

	.article__cover-container {
		margin-block-start: 48px;
		border-radius: var(--br-xl);
		background-color: var(--cover-color);
		width: 100%;
	}

	.article__cover {
		display: flex;
		transform: scale(0.9);
		background-color: var(--bg-secondary);
		width: 100%;
	}

	.article__content,
	.article__next-page {
		grid-column: 2 / span 1;
	}

	.article__toc {
		grid-column: 3 / span 1;
		margin-inline-start: 64px;
	}

	.article__content {
	}
</style>
